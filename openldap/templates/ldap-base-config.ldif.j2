{%- from 'openldap/map.jinja' import openldap with context %}
#
# THIS FILE IS MANAGED BY SALT - DO NOT EDIT MANUALLY
#

## Set base suffix

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: {{ openldap.base }}

## Set base dn

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: {{ openldap.rootdn }}

## Set root pw

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: {{ openldap.rootpw }}

## Modify access rights for LDAP DB (give ext auth manage rights)
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="{{ openldap.rootdn }}" manage by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" manage by * none

## Modify monitor access rights

dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth" read by dn.base="{{ openldap.rootdn }}" read by * none

{%- if 'cert' and 'key' in openldap.keys() %}
## Modify x509 certificate location

dn: cn=config
changetype: modify
replace: olcTLSCertificateFile
olcTLSCertificateFile: {{ openldap.cert }}

dn: cn=config
changetype: modify
replace: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: {{ openldap.key }}

{% endif -%}
